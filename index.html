<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Long/Short">
  <meta name="theme-color" content="#111827">
  <title>Long/Short Dashboard</title>
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior: none; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div id="app"></div>

  <script>
    // Data
    const dashboardData = {
      items: [
        {category: "NITROGENADOS", produto: "NK 42 00 05", eta: "ETA 20/10 - MV ALANOOD", az: "A DEFINIR", val: 10000, isJV: false},
        {category: "NITROGENADOS", produto: "NK 42 00 05", eta: "MV SHANDONGXINFU", az: "A DEFINIR", val: 19597.93, isJV: false},
        {category: "NITROGENADOS", produto: "ACL", eta: "DISPONIVEL", az: "MULTITRANS", val: 642, isJV: false},
        {category: "NITROGENADOS", produto: "SULF STD FERTISERVICE", eta: "DISPONIVEL", az: "FERTISERVICE", val: 81, isJV: false},
        {category: "NITROGENADOS", produto: "SULF STD MULTITRANS", eta: "DISPONIVEL", az: "MULTITRANS", val: 2670, isJV: false},
        {category: "NITROGENADOS", produto: "SULF STD MULTITRANS", eta: "DISPONIVEL", az: "MULTITRANS", val: 2530.32, isJV: false},
        {category: "NITROGENADOS", produto: "SULFATO DE AMONIO STD", eta: "DISPONIVEL", az: "FERTISERVICE", val: 136, isJV: false},
        {category: "NITROGENADOS", produto: "GAS MARINGA", eta: "DISPONIVEL", az: "MULTITRANS MARINGA", val: -265.04, isJV: false},
        {category: "NITROGENADOS", produto: "SULFATO 20.23 P√ì", eta: "DISPONIVEL", az: "MULTITRANS MARINGA", val: 225, isJV: false},
        {category: "NITROGENADOS", produto: "GAS PARANAGUA", eta: "LAYCAN NOV", az: "DPU", val: 1912, isJV: false},
        {category: "NITROGENADOS", produto: "GAS SEG - CL", eta: "DISPONIVEL", az: "AZ DREYMOOR CL", val: 4, isJV: false},
        {category: "NITROGENADOS", produto: "GAS ITAQUI", eta: "LAYCAN NOV", az: "A DEFINIR", val: 900, isJV: false},
        {category: "NITROGENADOS", produto: "GAS CAMPO LARGO", eta: "DISPONIVEL", az: "AZ DREYMOOR CL", val: 31, isJV: false},
        {category: "NITROGENADOS", produto: "GAS MIRITITUBA", eta: "MV XING AN HAI", az: "MASTER/DB", val: -265, isJV: false},
        {category: "NITROGENADOS", produto: "SAM 20 23 RONDONOPOLIS", eta: "DISPONIVEL", az: "AZ COPAS", val: 7.14, isJV: false},
        {category: "NITROGENADOS", produto: "GAS SANTAREM", eta: "MV XING AN HAI", az: "MASTER", val: 1, isJV: false},
        {category: "NITROGENADOS", produto: "SULFATO 20.23", eta: "MV SHANDONGXINFU", az: "EXTRACARGO", val: 656, isJV: false},
        {category: "NITROGENADOS", produto: "SULFATO 20 23", eta: "LAYCAN DEZ", az: "A DEFINIR - PNG", val: 860, isJV: false},
        {category: "NITROGENADOS", produto: "SULFATO 20 23", eta: "DISPONIVEL", az: "COONAGRO", val: 1000, isJV: false},
        {category: "NITROGENADOS", produto: "SULFATO 20 23", eta: "DISPONIVEL", az: "DREYMOOR/MASTER", val: 25, isJV: false},
        {category: "NITROGENADOS", produto: "UREIA GRANEL", eta: "ETA 02/10", az: "MULTITRANS", val: 1000, isJV: false},
        {category: "NITROGENADOS", produto: "UREIA PEROLADA", eta: "ETA 02/10", az: "MULTITRANS", val: -38, isJV: false},
        {category: "NITROGENADOS", produto: "UREIA PRILL", eta: "MV ALANOOD", az: "FERTISERVICE", val: 5256, isJV: false},
        {category: "NITROGENADOS", produto: "UREIA GRANULADA BAG", eta: "MV ALANOOD", az: "DREYMOOR CL", val: 3896.03, isJV: false},
        {category: "NITROGENADOS", produto: "UREIA PRILL", eta: "MV SHANDONGXINFU", az: "AZ EXTRA CARGO", val: 152.92, isJV: false},
        {category: "NITROGENADOS", produto: "UREIA PRILL", eta: "MV SHANDONGXINFU", az: "AZ CAMPO LARGO", val: 200, isJV: false},
        {category: "NITROGENADOS", produto: "UREIA GR", eta: "MV SHANDONGXINFU", az: "LOGIMODAL - SFC", val: 593, isJV: false},
        {category: "NITROGENADOS", produto: "UREIA TECNICA", eta: "DISPONIVEL", az: "AZ CAMPO LARGO", val: 2350, isJV: false},
        {category: "ROCHA FOSF√ÅTICA", produto: "FREATIVO VL CONDE", eta: "ETA 29/07", az: "MF LOG", val: 9, isJV: false},
        {category: "ROCHA FOSF√ÅTICA", produto: "FREATIVO PNG", eta: "ETB 05/10", az: "MULTITRANS", val: 204, isJV: false},
        {category: "ROCHA FOSF√ÅTICA", produto: "FOSFATO REATIVO", eta: "LAYCAN OUT", az: "A DEFINIR", val: 2200, isJV: false},
        {category: "FOSFATADOS", produto: "MC 00 18 00 - BB", eta: "DISPONIVEL", az: "FERTALVO", val: 1460, isJV: false},
        {category: "FOSFATADOS", produto: "NP 08-40 SANTAREM", eta: "DISPONIVEL", az: "DREYMOOR PAR√Å", val: 1742, isJV: false},
        {category: "FOSFATADOS", produto: "SSP 19 INTERMARITIMA", eta: "DISPONIVEL", az: "INTERMARITIMA/BA", val: 550, isJV: false},
        {category: "FOSFATADOS", produto: "SSP 20 MIRITITUBA", eta: "DISPONIVEL", az: "MASTER/DB", val: 6900.51, isJV: false},
        {category: "FOSFATADOS", produto: "SSP 20 RONDONOPOLIS", eta: "DISPONIVEL", az: "AZ SAGEL", val: 2047, isJV: false},
        {category: "FOSFATADOS", produto: "SSP", eta: "WORLD PROSPER", az: "JV", val: 13425, isJV: true},
        {category: "FOSFATADOS", produto: "NP 11 44", eta: "WORLD PROSPER", az: "JV", val: 14000, isJV: true},
        {category: "POTASSIO", produto: "KCL BAG COPAS", eta: "DISPONIVEL", az: "COPAS/MT", val: 3, isJV: false},
        {category: "POTASSIO", produto: "KCL P√ì BRANCO", eta: "DISPONIVEL", az: "DREYMOOR CL", val: 80, isJV: false},
        {category: "POTASSIO", produto: "KCL GRANEL", eta: "DISPONIVEL", az: "ANDALI/GO", val: 829, isJV: false},
        {category: "POTASSIO", produto: "KCL GRANEL", eta: "MV SCARLET CYPRESS", az: "A DEFINIR", val: 111, isJV: false},
        {category: "POTASSIO", produto: "KCL BAG ANDALI", eta: "NOVEMBRO", az: "ANDALI/GO", val: 16, isJV: false},
        {category: "POTASSIO", produto: "KCL BAG MOSAIC", eta: "DISPONIVEL", az: "MOSAIC/ROO", val: 77, isJV: false},
        {category: "POTASSIO", produto: "KCL BAG ANDALI", eta: "DISPONIVEL", az: "ANDALI/GO", val: -35, isJV: false},
        {category: "GERAL", produto: "NITRATO DE CALCIO", eta: "ETA 20/10", az: "DREYMOOR CL", val: 125, isJV: false},
        {category: "GERAL", produto: "BORAX PNG", eta: "DISPONIVEL", az: "AZ GOBBOR", val: 456, isJV: false},
        {category: "GERAL", produto: "CAN CAMPO LARGO", eta: "DISPONIVEL", az: "AZ DREYMOOR CL", val: 23.64, isJV: false},
        {category: "GERAL", produto: "CAN ARAXA", eta: "DISPONIVEL", az: "AZ DREYMOOR MG", val: 200.75, isJV: false}
      ],
      updated: "22/01/2026"
    };

    const COLORS = {
      NITROGENADOS: '#3b82f6',
      FOSFATADOS: '#22c55e',
      'ROCHA FOSF√ÅTICA': '#a16207',
      POTASSIO: '#ef4444',
      GERAL: '#a855f7'
    };

    // State
    let state = {
      includeJV: false,
      tab: 'overview',
      search: '',
      category: 'ALL',
      expanded: null
    };

    // Helpers
    const fmt = n => new Intl.NumberFormat('pt-BR', {maximumFractionDigits: 0}).format(n);
    const fmtFull = n => new Intl.NumberFormat('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(n);

    function getData() {
      return state.includeJV ? dashboardData.items : dashboardData.items.filter(i => !i.isJV);
    }

    function getCategoryTotals() {
      const totals = {};
      getData().forEach(i => {
        if (!totals[i.category]) totals[i.category] = {total: 0, short: 0};
        totals[i.category].total += i.val;
        if (i.val < 0) totals[i.category].short += Math.abs(i.val);
      });
      return totals;
    }

    function getProducts() {
      const summary = {};
      getData().forEach(i => {
        if (!summary[i.produto]) summary[i.produto] = {name: i.produto, category: i.category, total: 0, locs: [], isJV: i.isJV};
        summary[i.produto].total += i.val;
        summary[i.produto].locs.push({az: i.az, eta: i.eta, val: i.val});
      });
      let products = Object.values(summary).sort((a, b) => b.total - a.total);
      if (state.search) products = products.filter(p => p.name.toLowerCase().includes(state.search.toLowerCase()));
      if (state.category !== 'ALL') products = products.filter(p => p.category === state.category);
      return products;
    }

    function getShorts() {
      return getData().filter(i => i.val < 0);
    }

    // Render
    function render() {
      const data = getData();
      const totals = getCategoryTotals();
      const totalLong = Object.values(totals).reduce((s, c) => s + Math.max(0, c.total), 0);
      const totalShort = Object.values(totals).reduce((s, c) => s + c.short, 0);
      const shorts = getShorts();
      const jvTotal = dashboardData.items.filter(i => i.isJV).reduce((s, i) => s + i.val, 0);
      const products = getProducts();

      document.getElementById('app').innerHTML = `
        <!-- Header -->
        <div class="bg-gray-800 px-4 py-3 sticky top-0 z-50 border-b border-gray-700 safe-area-inset">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-lg font-bold">üìä Long/Short</h1>
              <p class="text-xs text-gray-400">Atualizado: ${dashboardData.updated}</p>
            </div>
            <button onclick="toggleJV()" class="px-3 py-1.5 rounded-full text-xs font-medium ${state.includeJV ? 'bg-amber-600' : 'bg-gray-700'}">
              JV ${state.includeJV ? 'ON' : 'OFF'}
            </button>
          </div>
        </div>

        <!-- KPIs -->
        <div class="p-3 grid grid-cols-2 gap-2">
          <div class="bg-blue-900/50 rounded-xl p-3">
            <p class="text-blue-300 text-xs">Total Long</p>
            <p class="text-xl font-bold">${fmt(totalLong)}</p>
            <p class="text-blue-400 text-xs">ton</p>
          </div>
          <div class="bg-red-900/50 rounded-xl p-3">
            <p class="text-red-300 text-xs">Total Short</p>
            <p class="text-xl font-bold">${fmt(totalShort)}</p>
            <p class="text-red-400 text-xs">ton em risco</p>
          </div>
          <div class="bg-emerald-900/50 rounded-xl p-3">
            <p class="text-emerald-300 text-xs">Net Position</p>
            <p class="text-xl font-bold">${fmt(totalLong - totalShort)}</p>
            <p class="text-emerald-400 text-xs">ton l√≠quidas</p>
          </div>
          <div class="bg-amber-900/50 rounded-xl p-3">
            <p class="text-amber-300 text-xs">JV Total</p>
            <p class="text-xl font-bold">${fmt(jvTotal)}</p>
            <p class="text-amber-400 text-xs">${state.includeJV ? 'inclu√≠do' : 'exclu√≠do'}</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-700 px-2">
          <button onclick="setTab('overview')" class="flex-1 py-3 text-sm font-medium border-b-2 ${state.tab === 'overview' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-500'}">
            üìà Vis√£o
          </button>
          <button onclick="setTab('products')" class="flex-1 py-3 text-sm font-medium border-b-2 ${state.tab === 'products' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-500'}">
            üì¶ Produtos
          </button>
          <button onclick="setTab('alerts')" class="flex-1 py-3 text-sm font-medium border-b-2 ${state.tab === 'alerts' ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-500'}">
            ‚ö†Ô∏è Alertas (${shorts.length})
          </button>
        </div>

        <!-- Content -->
        <div class="p-3">
          ${state.tab === 'overview' ? renderOverview(totals, totalLong) : ''}
          ${state.tab === 'products' ? renderProducts(products) : ''}
          ${state.tab === 'alerts' ? renderAlerts(shorts, totalShort) : ''}
        </div>

        <div class="h-20"></div>
      `;

      if (state.tab === 'overview') renderCharts(totals);
    }

    function renderOverview(totals, totalLong) {
      return `
        <div class="space-y-4">
          <div class="bg-gray-800 rounded-xl p-4">
            <h3 class="text-sm font-semibold mb-3">Por Categoria</h3>
            <div style="height:160px"><canvas id="pieChart"></canvas></div>
            <div class="flex flex-wrap justify-center gap-2 mt-3">
              ${Object.entries(COLORS).map(([n, c]) => `
                <div class="flex items-center gap-1">
                  <div class="w-2 h-2 rounded-full" style="background:${c}"></div>
                  <span class="text-xs text-gray-400">${n.substring(0,6)}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="bg-gray-800 rounded-xl p-4">
            <h3 class="text-sm font-semibold mb-3">Volume por Categoria</h3>
            <div class="space-y-3">
              ${Object.entries(totals).sort((a,b) => b[1].total - a[1].total).map(([cat, d]) => `
                <div>
                  <div class="flex justify-between text-xs mb-1">
                    <span style="color:${COLORS[cat]}">${cat}</span>
                    <span class="text-gray-400">${fmt(d.total)} ton</span>
                  </div>
                  <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full rounded-full" style="width:${Math.max(0, (d.total/totalLong)*100)}%;background:${COLORS[cat]}"></div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderProducts(products) {
      return `
        <div class="space-y-3">
          <input type="text" placeholder="üîç Buscar produto..." value="${state.search}" 
            oninput="setSearch(this.value)"
            class="w-full bg-gray-800 rounded-xl px-4 py-3 text-sm placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
          
          <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
            <button onclick="setCategory('ALL')" class="px-3 py-1.5 rounded-full text-xs whitespace-nowrap ${state.category === 'ALL' ? 'bg-blue-600' : 'bg-gray-700'}">Todos</button>
            ${Object.keys(COLORS).map(c => `
              <button onclick="setCategory('${c}')" class="px-3 py-1.5 rounded-full text-xs whitespace-nowrap ${state.category === c ? 'bg-blue-600' : 'bg-gray-700'}">${c.substring(0,8)}</button>
            `).join('')}
          </div>

          <div class="space-y-2">
            ${products.length === 0 ? '<p class="text-center text-gray-500 py-4">Nenhum produto encontrado</p>' : ''}
            ${products.map((p, i) => `
              <div class="bg-gray-800 rounded-xl overflow-hidden ${p.total < 0 ? 'border border-red-800' : ''}">
                <button onclick="toggleExpand(${i})" class="w-full p-3 flex items-center justify-between text-left">
                  <div>
                    <p class="font-medium text-sm">${p.name}</p>
                    <div class="flex items-center gap-2 mt-1">
                      <span class="text-xs px-2 py-0.5 rounded" style="background:${COLORS[p.category]}33;color:${COLORS[p.category]}">${p.category.substring(0,6)}</span>
                      ${p.isJV ? '<span class="text-xs px-2 py-0.5 rounded bg-amber-900/50 text-amber-400">JV</span>' : ''}
                      <span class="text-xs text-gray-500">${p.locs.length} loc.</span>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="text-lg font-bold ${p.total < 0 ? 'text-red-400' : 'text-emerald-400'}">${fmt(p.total)}</p>
                    <p class="text-xs text-gray-500">ton</p>
                  </div>
                </button>
                ${state.expanded === i ? `
                  <div class="px-3 pb-3 border-t border-gray-700">
                    <p class="text-xs text-gray-500 py-2">Localiza√ß√µes:</p>
                    ${p.locs.map(l => `
                      <div class="flex justify-between py-1.5 border-b border-gray-700/50 last:border-0">
                        <div>
                          <p class="text-xs text-gray-300">${l.az}</p>
                          <p class="text-xs text-gray-500">${l.eta}</p>
                        </div>
                        <p class="text-sm font-medium ${l.val < 0 ? 'text-red-400' : 'text-gray-300'}">${fmtFull(l.val)}</p>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderAlerts(shorts, totalShort) {
      if (shorts.length === 0) {
        return `
          <div class="bg-emerald-900/30 rounded-xl p-6 text-center">
            <p class="text-4xl mb-2">‚úÖ</p>
            <p class="text-emerald-400 font-medium">Sem posi√ß√µes short!</p>
            <p class="text-emerald-600 text-sm">Todas as posi√ß√µes est√£o cobertas</p>
          </div>
        `;
      }
      return `
        <div class="space-y-3">
          <div class="bg-red-900/30 rounded-xl p-3 border border-red-800">
            <p class="text-red-400 text-sm font-medium">‚ö†Ô∏è ${shorts.length} posi√ß√µes em risco</p>
            <p class="text-red-300 text-2xl font-bold">${fmt(totalShort)} ton</p>
          </div>
          ${shorts.map(s => `
            <div class="bg-red-950/50 rounded-xl p-3 border border-red-900">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-medium text-red-300">${s.produto}</p>
                  <p class="text-xs text-red-400/70">${s.az}</p>
                  <p class="text-xs text-red-400/70">${s.eta}</p>
                </div>
                <div class="text-right">
                  <p class="text-xl font-bold text-red-500">${fmt(s.val)}</p>
                  <p class="text-xs text-red-400">ton</p>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderCharts(totals) {
      const ctx = document.getElementById('pieChart');
      if (!ctx) return;
      
      const data = Object.entries(totals).filter(([,d]) => d.total > 0);
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.map(([n]) => n.substring(0,8)),
          datasets: [{
            data: data.map(([,d]) => d.total),
            backgroundColor: data.map(([n]) => COLORS[n]),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => fmt(ctx.raw) + ' ton'
              }
            }
          }
        }
      });
    }

    // Actions
    function toggleJV() {
      state.includeJV = !state.includeJV;
      render();
    }

    function setTab(tab) {
      state.tab = tab;
      state.expanded = null;
      render();
    }

    function setSearch(val) {
      state.search = val;
      render();
    }

    function setCategory(cat) {
      state.category = cat;
      render();
    }

    function toggleExpand(idx) {
      state.expanded = state.expanded === idx ? null : idx;
      render();
    }

    // Init
    render();
  </script>
</body>
</html>
